# План оптимизации фронтенда

## 1. Приоритетные фейлы (срочно исправить)

1. **Users API вызывает несуществующие методы**
   - `useUsersStore` дергает `usersApi.createUser/updateUser/deleteUser`, но в API объявлены только `create/update/delete`.
   - Любое CRUD‑действие админа по пользователям падает с `is not a function`.
   - Нужно либо переименовать вызовы в сторах, либо добавить одноимённые функции в `usersApi`.

2. **Отмена заказа не работает**
   - `useOrdersStore.cancelOrder()` обращается к `orderApi.cancelOrder`, которого нет.
   - Любая попытка отмены заказа заканчивается исключением.
   - Добавить эндпоинт или использовать существующий REST‑метод и вернуть обновлённый заказ.

3. **AdminErrorBoundary ничего не перехватывает**
   - Компонент объявляет функцию `onErrorCaptured`, но никогда не регистрирует хуки Vue.
   - Ошибки в админке не показывают fallback, весь UI рушится.
   - Подключить `onErrorCaptured` внутри `<script setup>` и выводить fallback‑карточку.

4. **Инициализация authStore выполняется дважды**
   - В `main.js` и `App.vue` вызывается `authStore.initialize()`.
   - Дублирует запросы, гоняет декод токена и даёт race conditions с корзиной.
   - Оставить инициализацию только в `main.js` перед `app.mount`.

5. **Компоненты мутируют состояние Pinia напрямую**
   - Например, `BookList` присваивает `booksStore.category = props.category` и т.д.
   - Ломает девтулы, усложняет тесты и скрывает побочные эффекты.
   - Ввести явные экшены `setFilters/applyFilters`.

## 2. План оптимизации

### Быстрые победы
- Переименовать/добавить методы в `usersApi` и `orderApi`, покрыть smoke‑тестами.
- Удалить двойной вызов `authStore.initialize`.
- Подключить `onErrorCaptured` и централизованный error fallback.
- Заменить прямые присвоения сторам на экшены (books, authors, orders, cart).
- Привести форматирование цен/статусов к единому helper’у (`Intl.NumberFormat` + enum статусов).

### Среднесрочно
- Вынести `useNotifications` в одноразовый плагин (store’ы больше не импортируют UI).
- Объединить роуты в один список + единый guard, использовать meta `auth/roles`.
- Сжать API‑слой до фабрики или прямых вызовов axios, оставить только доменные методы.
- Пересобрать структуру директорий по доменам (`src/modules/<domain>`), удалить пустые `layouts`/`store/utils`.
- Сократить дублирующие normalizer’ы и фильтры: фильтрация/сортировка остаётся в компонентах или специализированных composables.

### Крупные изменения
- Разделить Pinia‑модули на мелкие доменные store’ы с selector’ами; держать только данные и мутации.
- Переписать глобальные диалоги/нотификации через `provide/inject`, чтобы SSR и тесты были детерминированными.
- Добавить backend‑эндпоинт `/admin/summary`, чтобы дашборд не грузил все списки подряд.
- Свести error/log инфраструктуру к одному модулю (`app/core/logging`) и избавиться от классового `ErrorHandler`.

## 3. Метрики успеха
- CRUD по пользователям и заказам проходит без ошибок (e2e сценарии админки).
- Навигация авторизованного пользователя занимает ≤1 запроса к auth‑стеку при загрузке.
- Количество глобальных watchers в `useNotifications` не растёт после серии операций (фиксация памяти).
- Lighthouse/Perf: страница `/admin` не делает более 2 параллельных API запросов при первом рендере.

## 4. Следующие шаги
1. Исправить критические фейлы (раздел 1) и добавить smoke‑тест на user/order CRUD.
2. Обновить сторы на использование экшенов и вынести уведомления из бизнес‑логики.
3. Сформировать новую структуру каталогов и мигрировать натянутые композаблы/утилиты.

