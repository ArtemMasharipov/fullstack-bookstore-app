# –ú–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã API

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã API –≤ –ø—Ä–æ–µ–∫—Ç–µ (—Ä–∞–∑–¥–µ–ª `/backend`), —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ª—É—á—à–µ–π –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã.

## 1. –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

```
backend/
‚îú‚îÄ‚îÄ src/                      # –í–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/                  # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ v1/               # API –≤–µ—Ä—Å–∏—è 1
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/  # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã API
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/       # –ú–∞—Ä—à—Ä—É—Ç—ã API
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.mjs     # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ API v1
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.mjs         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π API
‚îÇ   ‚îú‚îÄ‚îÄ domain/               # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –¥–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ books/            # –ö–Ω–∏–≥–∏ - –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authors/          # –ê–≤—Ç–æ—Ä—ã - –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/             # –ö–æ—Ä–∑–∏–Ω–∞ - –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users/            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –¥–æ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/       # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/         # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/       # Mongoose –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/ # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.mjs     # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ —ç–∫—Å–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/         # –û–±—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/         # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage/      # –†–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache/        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger/       # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Middleware –¥–ª—è Express
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ app.mjs               # –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ test/                     # –¢–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ unit/                 # –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ integration/          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ api/                  # API —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/             # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ scripts/                  # –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –¥–µ–ø–ª–æ—è
‚îú‚îÄ‚îÄ logs/                     # –õ–æ–≥–∏ (–¥–æ–±–∞–≤–∏—Ç—å –≤ .gitignore)
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É API, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ API
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## 2. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–ª–æ—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ú–æ–¥–µ–ª–∏ MongoDB –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö, —á—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Å–∏–ª—å–Ω—É—é —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å —Å–ª–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –¥–ª—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º:

```javascript
// infrastructure/database/repositories/bookRepository.mjs
import { Book } from '../models/book.mjs';

export class BookRepository {
  async findAll(filters = {}, options = {}) {
    const { page = 1, limit = 10, sort = { createdAt: -1 } } = options;
    const skip = (page - 1) * limit;
    
    return Book.find(filters)
      .sort(sort)
      .skip(skip)
      .limit(parseInt(limit))
      .lean();
  }

  async findById(id) {
    return Book.findById(id).lean();
  }

  async create(bookData) {
    const book = new Book(bookData);
    return book.save();
  }

  async update(id, bookData) {
    return Book.findByIdAndUpdate(
      id, 
      bookData,
      { new: true, runValidators: true }
    );
  }

  async delete(id) {
    return Book.findByIdAndDelete(id);
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –¥–æ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö

```javascript
// domain/books/bookService.mjs
import { BookRepository } from '../../infrastructure/database/repositories/bookRepository.mjs';

export class BookService {
  constructor() {
    this.bookRepository = new BookRepository();
  }

  async getAllBooks(filters, options) {
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞...
    return this.bookRepository.findAll(filters, options);
  }

  async getBookById(id) {
    return this.bookRepository.findById(id);
  }

  // –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã...
}
```

## 3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

```javascript
// infrastructure/errors/AppError.mjs
export class AppError extends Error {
  constructor(message, statusCode, isOperational = true) {
    super(message);
    this.statusCode = statusCode;
    this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error';
    this.isOperational = isOperational;

    Error.captureStackTrace(this, this.constructor);
  }
}

// infrastructure/middleware/errorHandler.mjs
import { AppError } from '../errors/AppError.mjs';

export const errorHandler = (err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || 'error';

  if (process.env.NODE_ENV === 'development') {
    sendErrorDev(err, res);
  } else if (process.env.NODE_ENV === 'production') {
    let error = { ...err };
    error.message = err.message;

    if (err.name === 'CastError') error = handleCastErrorDB(error);
    if (err.code === 11000) error = handleDuplicateFieldsDB(error);
    if (err.name === 'ValidationError') error = handleValidationErrorDB(error);
    if (err.name === 'JsonWebTokenError') error = handleJWTError();
    if (err.name === 'TokenExpiredError') error = handleJWTExpiredError();

    sendErrorProd(error, res);
  }
};

const sendErrorDev = (err, res) => {
  res.status(err.statusCode).json({
    status: err.status,
    error: err,
    message: err.message,
    stack: err.stack
  });
};

const sendErrorProd = (err, res) => {
  // Operational, trusted error: send message to client
  if (err.isOperational) {
    res.status(err.statusCode).json({
      status: err.status,
      message: err.message
    });
  } 
  // Programming or other unknown error: don't leak error details
  else {
    // Log error
    console.error('ERROR üí•', err);

    // Send generic message
    res.status(500).json({
      status: 'error',
      message: 'Something went wrong'
    });
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫...
const handleCastErrorDB = err => {
  const message = `Invalid ${err.path}: ${err.value}.`;
  return new AppError(message, 400);
};

const handleDuplicateFieldsDB = err => {
  const value = err.errmsg.match(/(["'])(\\?.)*?\1/)[0];
  const message = `Duplicate field value: ${value}. Please use another value!`;
  return new AppError(message, 400);
};

// ...–¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
```

## 4. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ DI (Dependency Injection)

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç —Å–≤–æ–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä DI:

```javascript
// infrastructure/di/container.mjs
class Container {
  constructor() {
    this.services = {};
    this.singletons = {};
  }

  register(name, definition, dependencies = []) {
    this.services[name] = { definition, dependencies };
  }

  singleton(name, definition, dependencies = []) {
    this.register(name, definition, dependencies);
    this.singletons[name] = true;
  }

  get(name) {
    const service = this.services[name];
    if (!service) {
      throw new Error(`Service '${name}' not found`);
    }

    // Return cached singleton instance if exists
    if (this.singletons[name] && this.singletons[name] !== true) {
      return this.singletons[name];
    }

    // Resolve dependencies
    const dependencies = service.dependencies.map(dep => this.get(dep));
    
    // Create instance
    const instance = typeof service.definition === 'function' 
      ? new service.definition(...dependencies) 
      : service.definition;

    // Cache singleton instance
    if (this.singletons[name] === true) {
      this.singletons[name] = instance;
    }

    return instance;
  }
}

export const container = new Container();
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DI

```javascript
// setup/di.mjs
import { container } from '../infrastructure/di/container.mjs';
import { BookRepository } from '../infrastructure/database/repositories/bookRepository.mjs';
import { BookService } from '../domain/books/bookService.mjs';
import { BookController } from '../api/v1/controllers/bookController.mjs';

export function setupDI() {
  // Repositories
  container.register('bookRepository', BookRepository);
  
  // Services
  container.singleton('bookService', BookService, ['bookRepository']);
  
  // Controllers
  container.register('bookController', BookController, ['bookService']);

  // ... —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä—É–≥–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  
  return container;
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API

```javascript
// api/v1/routes/bookRoutes.mjs
import express from 'express';
import { container } from '../../../infrastructure/di/container.mjs';

const router = express.Router();
const bookController = container.get('bookController');

router.get('/', bookController.getAllBooks.bind(bookController));
router.get('/:id', bookController.getBook.bind(bookController));
// ...–¥—Ä—É–≥–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã

export default router;
```

## 5. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é middleware.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Joi –∏–ª–∏ Yup –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–π –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```javascript
// infrastructure/validation/validators/bookValidator.mjs
import Joi from 'joi';

const bookSchema = Joi.object({
  title: Joi.string().min(2).max(100).required()
    .messages({
      'string.base': `"title" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–µ–∫—Å—Ç–æ–º`,
      'string.empty': `"title" –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º`,
      'string.min': `"title" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º {#limit} —Å–∏–º–≤–æ–ª–æ–≤`,
      'string.max': `"title" –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞–∫—Å–∏–º—É–º {#limit} —Å–∏–º–≤–æ–ª–æ–≤`,
      'any.required': `"title" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`
    }),
  
  price: Joi.number().min(0).required()
    .messages({
      'number.base': `"price" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º`,
      'number.min': `"price" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º`,
      'any.required': `"price" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`
    }),
  
  // –¥—Ä—É–≥–∏–µ –ø–æ–ª—è...
});

export const validateBook = (data) => bookSchema.validate(data, { abortEarly: false });
```

### Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

```javascript
// infrastructure/middleware/validationMiddleware.mjs
import { AppError } from '../errors/AppError.mjs';

export const validate = (validator) => {
  return (req, res, next) => {
    const { error } = validator(req.body);
    
    if (error) {
      const errorMessages = error.details.map(detail => detail.message).join(', ');
      return next(new AppError(errorMessages, 400));
    }
    
    next();
  };
};
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö

```javascript
// api/v1/routes/bookRoutes.mjs
import { validate } from '../../../infrastructure/middleware/validationMiddleware.mjs';
import { validateBook } from '../../../infrastructure/validation/validators/bookValidator.mjs';

router.post('/', validate(validateBook), bookController.createBook.bind(bookController));
```

## 6. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–ë–∞–∑–æ–≤–æ–µ –∏–ª–∏ –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Winston:

```javascript
// infrastructure/services/logger/index.mjs
import winston from 'winston';
import path from 'path';
import config from '../../config/index.mjs';

const { createLogger, format, transports } = winston;
const { combine, timestamp, printf, colorize, json } = format;

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥
const developmentFormat = combine(
  colorize(),
  timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  printf(({ level, message, timestamp, ...meta }) => {
    return `${timestamp} ${level}: ${message} ${Object.keys(meta).length ? JSON.stringify(meta) : ''}`;
  })
);

const productionFormat = combine(
  timestamp(),
  json()
);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤
const devTransports = [
  new transports.Console()
];

const prodTransports = [
  new transports.File({ 
    filename: path.join(config.logsDir, 'error.log'), 
    level: 'error'
  }),
  new transports.File({ 
    filename: path.join(config.logsDir, 'combined.log') 
  }),
];

// –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞
const logger = createLogger({
  level: config.env === 'development' ? 'debug' : 'info',
  format: config.env === 'development' ? developmentFormat : productionFormat,
  transports: config.env === 'development' ? devTransports : prodTransports,
});

export default logger;
```

## 7. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á —Å –ø–æ–º–æ—â—å—é Bull:

```javascript
// infrastructure/services/queue/index.mjs
import Queue from 'bull';
import config from '../../config/index.mjs';
import logger from '../logger/index.mjs';

// –°–æ–∑–¥–∞–Ω–∏–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π
export const createQueue = (name) => {
  const queue = new Queue(name, {
    redis: config.redis,
    defaultJobOptions: {
      attempts: 3,
      backoff: {
        type: 'exponential',
        delay: 1000
      },
      removeOnComplete: true,
      removeOnFail: false
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—á–µ—Ä–µ–¥–∏
  queue.on('completed', (job) => {
    logger.info(`Job ${job.id} completed`, { queue: name, jobId: job.id });
  });

  queue.on('failed', (job, err) => {
    logger.error(`Job ${job.id} failed`, { 
      queue: name, 
      jobId: job.id,
      error: err.message,
      stack: err.stack
    });
  });

  return queue;
};

// –û—á–µ—Ä–µ–¥–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
export const emailQueue = createQueue('email');
export const reportQueue = createQueue('report');
// ... –¥—Ä—É–≥–∏–µ –æ—á–µ—Ä–µ–¥–∏
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

```javascript
// domain/orders/orderService.mjs
import { emailQueue } from '../../infrastructure/services/queue/index.mjs';

export class OrderService {
  // ...

  async createOrder(orderData) {
    const order = await this.orderRepository.create(orderData);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
    await emailQueue.add('orderConfirmation', { 
      orderId: order._id,
      email: orderData.email,
      items: orderData.items
    });
    
    return order;
  }
  
  // ...
}
```

### –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –æ—á–µ—Ä–µ–¥–∏

```javascript
// scripts/workers/email-worker.mjs
import { emailQueue } from '../../infrastructure/services/queue/index.mjs';
import { EmailService } from '../../infrastructure/services/email/emailService.mjs';
import logger from '../../infrastructure/services/logger/index.mjs';

const emailService = new EmailService();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á –æ—á–µ—Ä–µ–¥–∏
emailQueue.process('orderConfirmation', async (job) => {
  const { orderId, email, items } = job.data;
  
  logger.info(`Processing order confirmation email for order ${orderId}`);
  
  await emailService.sendOrderConfirmation(email, orderId, items);
  
  return { success: true };
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ email-–∑–∞–¥–∞—á
// ...

logger.info('Email worker started');
```

## 8. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Redis:

```javascript
// infrastructure/services/cache/index.mjs
import Redis from 'ioredis';
import logger from '../logger/index.mjs';
import config from '../../config/index.mjs';

class CacheService {
  constructor() {
    this.client = new Redis(config.redis);
    
    this.client.on('error', (error) => {
      logger.error('Redis error', { error: error.message });
    });
    
    this.client.on('connect', () => {
      logger.info('Connected to Redis');
    });
  }
  
  async get(key) {
    try {
      const data = await this.client.get(key);
      return data ? JSON.parse(data) : null;
    } catch (error) {
      logger.error('Cache get error', { key, error: error.message });
      return null;
    }
  }
  
  async set(key, value, ttl = 3600) {
    try {
      await this.client.set(
        key,
        JSON.stringify(value),
        'EX',
        ttl
      );
      return true;
    } catch (error) {
      logger.error('Cache set error', { key, error: error.message });
      return false;
    }
  }
  
  async del(key) {
    try {
      await this.client.del(key);
      return true;
    } catch (error) {
      logger.error('Cache delete error', { key, error: error.message });
      return false;
    }
  }
  
  async flush() {
    try {
      await this.client.flushdb();
      return true;
    } catch (error) {
      logger.error('Cache flush error', { error: error.message });
      return false;
    }
  }
}

export const cacheService = new CacheService();
```

### Middleware –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API

```javascript
// infrastructure/middleware/cacheMiddleware.mjs
import { cacheService } from '../services/cache/index.mjs';

export const cacheMiddleware = (ttl = 3600) => {
  return async (req, res, next) => {
    if (req.method !== 'GET') {
      return next();
    }
    
    const key = `cache:${req.originalUrl}`;
    
    try {
      const cachedData = await cacheService.get(key);
      
      if (cachedData) {
        return res.status(200).json(cachedData);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
      const sendResponse = res.json;
      
      // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞
      res.json = function(data) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
        res.json = sendResponse;
        
        // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        cacheService.set(key, data, ttl);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        return sendResponse.call(this, data);
      };
      
      next();
    } catch (error) {
      next();
    }
  };
};
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –º–∞—Ä—à—Ä—É—Ç–∞—Ö

```javascript
// api/v1/routes/bookRoutes.mjs
import { cacheMiddleware } from '../../../infrastructure/middleware/cacheMiddleware.mjs';

// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–Ω–∏–≥ –Ω–∞ 10 –º–∏–Ω—É—Ç
router.get('/', cacheMiddleware(600), bookController.getAllBooks.bind(bookController));
```

## 9. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å —Å–ª—É–∂–±—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```javascript
// infrastructure/database/transactionManager.mjs
import mongoose from 'mongoose';
import { AppError } from '../errors/AppError.mjs';

export class TransactionManager {
  async executeTransaction(callback) {
    const session = await mongoose.startSession();
    session.startTransaction();
    
    try {
      const result = await callback(session);
      await session.commitTransaction();
      return result;
    } catch (error) {
      await session.abortTransaction();
      throw new AppError(
        error.message || 'Transaction failed',
        error.statusCode || 500,
        error.isOperational || false
      );
    } finally {
      session.endSession();
    }
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö

```javascript
// domain/orders/orderService.mjs
import { TransactionManager } from '../../infrastructure/database/transactionManager.mjs';

export class OrderService {
  constructor(orderRepository, bookRepository, userRepository) {
    this.orderRepository = orderRepository;
    this.bookRepository = bookRepository;
    this.userRepository = userRepository;
    this.transactionManager = new TransactionManager();
  }

  async placeOrder(userId, orderData) {
    return this.transactionManager.executeTransaction(async (session) => {
      // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
      const bookIds = orderData.items.map(item => item.bookId);
      const books = await this.bookRepository.findByIds(bookIds, { session });
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –∫–Ω–∏–≥ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      for (const item of orderData.items) {
        const book = books.find(b => b._id.toString() === item.bookId);
        
        if (!book) {
          throw new AppError(`Book with id ${item.bookId} not found`, 404);
        }
        
        if (book.stock < item.quantity) {
          throw new AppError(`Not enough stock for book '${book.title}'`, 400);
        }
      }
      
      // 2. –û–±–Ω–æ–≤–ª—è–µ–º stock –∫–Ω–∏–≥
      for (const item of orderData.items) {
        await this.bookRepository.updateStock(
          item.bookId, 
          { $inc: { stock: -item.quantity } },
          { session }
        );
      }
      
      // 3. –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
      const order = await this.orderRepository.create(
        {
          user: userId,
          items: orderData.items,
          total: orderData.total,
          // –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞...
        },
        { session }
      );
      
      // 4. –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await this.userRepository.updateOrderHistory(
        userId,
        { $push: { orders: order._id } },
        { session }
      );
      
      return order;
    });
  }
}
```

## 10. API-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–í–Ω–µ–¥—Ä–∏—Ç—å Swagger/OpenAPI –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

```javascript
// infrastructure/middleware/swagger.mjs
import swaggerJSDoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';
import config from '../config/index.mjs';

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Bookstore API',
      version: '1.0.0',
      description: 'Bookstore API documentation',
    },
    servers: [
      {
        url: `http://localhost:${config.port}/api/v1`,
        description: 'Development server',
      },
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
        },
      },
    },
    security: [
      {
        bearerAuth: [],
      },
    ],
  },
  apis: ['./src/api/v1/routes/*.mjs', './src/domain/*/*.mjs'],
};

const swaggerSpec = swaggerJSDoc(options);

export function setupSwagger(app) {
  app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));
}
```

### –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –º–æ–¥–µ–ª–µ–π

```javascript
// api/v1/routes/bookRoutes.mjs

/**
 * @swagger
 * /books:
 *   get:
 *     summary: Get all books
 *     description: Retrieve a list of all books with pagination, sorting and filtering options
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           minimum: 1
 *         description: Page number
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           minimum: 1
 *           maximum: 100
 *         description: Results per page
 *     responses:
 *       200:
 *         description: A list of books
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Book'
 */
router.get('/', bookController.getAllBooks.bind(bookController));
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ—Å—Ç—å –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –±—ç–∫–µ–Ω–¥–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–Ω–µ–¥—Ä—è—Ç—å –∏—Ö –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ, –Ω–∞—á–∏–Ω–∞—è —Å –Ω–∞–∏–±–æ–ª–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π:

1. **–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø**: –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
2. **–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–ª–æ—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
3. **–¢—Ä–µ—Ç–∏–π —ç—Ç–∞–ø**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
4. **–ß–µ—Ç–≤–µ—Ä—Ç—ã–π —ç—Ç–∞–ø**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
5. **–ü—è—Ç—ã–π —ç—Ç–∞–ø**: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API

–≠—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –ø–æ—ç—Ç–∞–ø–Ω–æ, —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∏—Å–∫–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
